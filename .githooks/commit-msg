#!/bin/sh
#
# commit-msg hook -- validates conventional commit format.
# Activated by: just setup

msg_file="$1"
first_line=$(head -n 1 "$msg_file")

# Allow merge commits and fixup/squash commits through unchanged.
case "$first_line" in
    Merge\ *|fixup\!\ *|squash\!\ *) exit 0 ;;
esac

# Validate type prefix.
if ! echo "$first_line" | grep -qE '^(feat|fix|refactor|docs|test|ci|chore|perf): .+'; then
    echo "ERROR: commit message must match '<type>: <subject>'"
    echo ""
    echo "  Valid types: feat fix refactor docs test ci chore perf"
    echo ""
    echo "  Example:  feat: add camera orbit controls"
    echo ""
    echo "  See CONTRIBUTING.md for details."
    exit 1
fi

# Validate subject length (72 chars max).
len=$(echo "$first_line" | wc -c)
# wc -c counts the trailing newline, so subtract 1.
len=$((len - 1))
if [ "$len" -gt 72 ]; then
    echo "ERROR: subject line is $len chars (max 72)"
    echo ""
    echo "  Shorten the first line of your commit message."
    echo "  See CONTRIBUTING.md for details."
    exit 1
fi
